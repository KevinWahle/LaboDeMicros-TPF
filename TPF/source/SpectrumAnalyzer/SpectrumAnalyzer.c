/***************************************************************************//**
  @file		SpectrumAnalyzer.c
  @brief	Funciones para manejo de la matriz de LEDs analizador de espectros
  @author	Grupo 5
  @date		27 dic. 2022
 ******************************************************************************/

/*******************************************************************************
 * INCLUDE HEADER FILES
 ******************************************************************************/
#include "SpectrumAnalyzer.h"
#include <arm_math.h>
#include "MCAL/gpio.h"
#include <stdbool.h>
#include <stdlib.h>
/*******************************************************************************
 * CONSTANT AND MACRO DEFINITIONS USING #DEFINE
 ******************************************************************************/


/*******************************************************************************
 * ENUMERATIONS AND STRUCTURES AND TYPEDEFS
 ******************************************************************************/

/*******************************************************************************
 * VARIABLES WITH GLOBAL SCOPE
 ******************************************************************************/


/*******************************************************************************
 * FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS WITH FILE LEVEL SCOPE
 ******************************************************************************/


/*******************************************************************************
 * ROM CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/


/*******************************************************************************
 * STATIC VARIABLES AND CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/
static uint8_t bands_gain[4];

/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/
/*
    Equalizer(sample)
    setVumetro(sample):
        getShortFFT(samples)
        EncenderLeds(array)
    setVolume(int)
    setOut(sample)
*/
arm_rfft_fast_instance_f32 S;
float32_t pIn[512] = {-7.361812e-02,-5.847532e-02,-4.213668e-02,-2.493116e-02,-7.209196e-03,1.066173e-02,2.831060e-02,4.539025e-02,6.156974e-02,7.651200e-02,8.989641e-02,1.014522e-01,1.109565e-01,1.182147e-01,1.230720e-01,1.254410e-01,1.252750e-01,1.225570e-01,1.173369e-01,1.097309e-01,9.989647e-02,8.804104e-02,7.440658e-02,5.925377e-02,4.288325e-02,2.564047e-02,7.886079e-03,-1.003634e-02,-2.777494e-02,-4.494139e-02,-6.118527e-02,-7.621208e-02,-8.969956e-02,-1.013496e-01,-1.109486e-01,-1.182977e-01,-1.232420e-01,-1.257050e-01,-1.256196e-01,-1.229698e-01,-1.178271e-01,-1.102908e-01,-1.005192e-01,-8.872230e-02,-7.511323e-02,-5.997488e-02,-4.363430e-02,-2.638723e-02,-8.587863e-03,9.359012e-03,2.711070e-02,4.433428e-02,6.065943e-02,7.574663e-02,8.930467e-02,1.010647e-01,1.107751e-01,1.182316e-01,1.232978e-01,1.258706e-01,1.258882e-01,1.233606e-01,1.183348e-01,1.109069e-01,1.012371e-01,8.950501e-02,7.594254e-02,6.085388e-02,4.453737e-02,2.730520e-02,9.519763e-03,-8.466123e-03,-2.629979e-02,-4.359788e-02,-6.000145e-02,-7.519644e-02,-8.888441e-02,-1.007805e-01,-1.106317e-01,-1.182378e-01,-1.234493e-01,-1.261636e-01,-1.263223e-01,-1.239125e-01,-1.189871e-01,-1.116593e-01,-1.020688e-01,-9.040222e-02,-7.690186e-02,-6.183793e-02,-4.551750e-02,-2.827309e-02,-1.044285e-02,7.608723e-03,2.551318e-02,4.290772e-02,5.942071e-02,7.472672e-02,8.853580e-02,1.005478e-01,1.105205e-01,1.182639e-01,1.235979e-01,1.264313e-01,1.267266e-01,1.244310e-01,1.195926e-01,1.123509e-01,1.028395e-01,9.122574e-02,7.777097e-02,6.273060e-02,4.640747e-02,2.915693e-02,1.131353e-02,-6.766960e-03,-2.470490e-02,-4.215471e-02,-5.875853e-02,-7.415079e-02,-8.803975e-02,-1.001653e-01,-1.102578e-01,-1.181049e-01,-1.235607e-01,-1.265129e-01,-1.269084e-01,-1.247397e-01,-1.200365e-01,-1.129073e-01,-1.035038e-01,-9.198803e-02,-7.860161e-02,-6.364606e-02,-4.740089e-02,-3.017626e-02,-1.234991e-02,5.716838e-03,2.368183e-02,4.116729e-02,5.780489e-02,7.327337e-02,8.726279e-02,9.948473e-02,1.097044e-01,1.177135e-01,1.233311e-01,1.264451e-01,1.270002e-01,1.249871e-01,1.204547e-01,1.134863e-01,1.042141e-01,9.283843e-02,7.958382e-02,6.471288e-02,4.854358e-02,3.139137e-02,1.359026e-02,-4.480514e-03,-2.245994e-02,-3.998497e-02,-5.668953e-02,-7.226340e-02,-8.638466e-02,-9.873624e-02,-1.091118e-01,-1.173037e-01,-1.230876e-01,-1.263835e-01,-1.271562e-01,-1.253369e-01,-1.209780e-01,-1.142011e-01,-1.050960e-01,-9.384718e-02,-8.071698e-02,-6.594236e-02,-4.981878e-02,-3.270433e-02,-1.492561e-02,3.171836e-03,2.119767e-02,3.879897e-02,5.563511e-02,7.133904e-02,8.559588e-02,9.813838e-02,1.086902e-01,1.170334e-01,1.230254e-01,1.265308e-01,1.274686e-01,1.258323e-01,1.216422e-01,1.149859e-01,1.060069e-01,9.486582e-02,8.180787e-02,6.710867e-02,5.101869e-02,3.388517e-02,1.609461e-02,-2.045624e-03,-2.017250e-02,-3.786964e-02,-5.480279e-02,-7.064500e-02,-8.505264e-02,-9.774499e-02,-1.084631e-01,-1.169802e-01,-1.231417e-01,-1.268081e-01,-1.278898e-01,-1.263892e-01,-1.223318e-01,-1.157889e-01,-1.069053e-01,-9.584641e-02,-8.283252e-02,-6.815363e-02,-5.209027e-02,-3.494578e-02,-1.709099e-02,1.112931e-03,1.931056e-02,3.710605e-02,5.413975e-02,7.009570e-02,8.463652e-02,9.746085e-02,1.083238e-01,1.169795e-01,1.232493e-01,1.270385e-01,1.282548e-01,1.268628e-01,1.229098e-01,1.164547e-01,1.076282e-01,9.663299e-02,8.365889e-02,6.897240e-02,5.291542e-02,3.577739e-02,1.788589e-02,-3.489722e-04,-1.857137e-02,-3.644549e-02,-5.358248e-02,-6.962240e-02,-8.425629e-02,-9.718821e-02,-1.081445e-01,-1.168988e-01,-1.232887e-01,-1.271887e-01,-1.285038e-01,-1.272103e-01,-1.233320e-01,-1.169363e-01,-1.081716e-01,-9.722433e-02,-8.429608e-02,-6.964411e-02,-5.356949e-02,-3.640815e-02,-1.851797e-02,-2.534264e-04,1.800943e-02,3.590114e-02,5.308361e-02,6.918722e-02,8.387105e-02,9.686798e-02,1.078902e-01,1.167019e-01,1.231734e-01,1.271432e-01,1.284958e-01,1.272593e-01,1.234511e-01,1.171110e-01,1.084100e-01,9.752410e-02,8.463760e-02,7.003698e-02,5.402798e-02,3.692103e-02,1.907418e-02,8.518500e-04,-1.737638e-02,-3.525215e-02,-5.243114e-02,-6.852698e-02,-8.320176e-02,-9.621161e-02,-1.072754e-01,-1.161324e-01,-1.226425e-01,-1.266763e-01,-1.281296e-01,-1.269946e-01,-1.232834e-01,-1.170568e-01,-1.084757e-01,-9.770983e-02,-8.494881e-02,-7.046124e-02,-5.455153e-02,-3.755233e-02,-1.980916e-02,-1.657052e-03,1.652735e-02,3.436130e-02,5.150873e-02,6.761134e-02,8.232063e-02,9.537124e-02,1.064981e-01,1.154402e-01,1.220379e-01,1.261831e-01,1.277771e-01,1.267793e-01,1.232087e-01,1.171358e-01,1.086931e-01,9.805516e-02,8.543963e-02,7.110238e-02,5.531824e-02,3.841100e-02,2.074153e-02,2.650315e-03,-1.550818e-02,-3.333809e-02,-5.047731e-02,-6.660340e-02,-8.138405e-02,-9.451219e-02,-1.057284e-01,-1.147914e-01,-1.215201e-01,-1.258019e-01,-1.275368e-01,-1.266785e-01,-1.232679e-01,-1.173642e-01,-1.090650e-01,-9.856053e-02,-8.607396e-02,-7.184363e-02,-5.615879e-02,-3.933918e-02,-2.172472e-02,-3.677817e-03,1.443909e-02,3.226626e-02,4.944418e-02,6.562413e-02,8.047427e-02,9.369504e-02,1.050145e-01,1.141994e-01,1.210894e-01,1.255428e-01,1.274334e-01,1.267429e-01,1.235051e-01,1.177496e-01,1.096011e-01,9.925450e-02,8.688896e-02,7.274840e-02,5.715263e-02,4.040322e-02,2.281164e-02,4.746897e-03,-1.339985e-02,-3.125951e-02,-4.849924e-02,-6.477724e-02,-7.973348e-02,-9.306668e-02,-1.045296e-01,-1.138766e-01,-1.209104e-01,-1.255065e-01,-1.275658e-01,-1.270327e-01,-1.239241e-01,-1.183050e-01,-1.102840e-01,-1.000287e-01,-8.775023e-02,-7.369091e-02,-5.813014e-02,-4.138188e-02,-2.379364e-02,-5.731070e-03,1.244724e-02,3.038009e-02,4.770235e-02,6.407024e-02,7.914379e-02,9.260184e-02,1.041947e-01,1.136900e-01,1.208594e-01,1.255794e-01,1.277780e-01,1.273709e-01,1.243749e-01,1.188796e-01,1.109606e-01,1.007810e-01,8.857442e-02,7.455651e-02,5.902098e-02,4.231137e-02,2.472049e-02,6.608045e-03,-1.161197e-02,-2.961121e-02,-4.704071e-02,-6.349236e-02,-7.865004e-02,-9.224134e-02,-1.039614e-01,-1.135674e-01,-1.208756e-01,-1.257266e-01,-1.280363e-01,-1.277601e-01,-1.248791e-01,-1.194715e-01,-1.116604e-01,-1.015676e-01,-8.940195e-02,-7.543547e-02,-5.993590e-02,-4.321446e-02,-2.562699e-02,-7.517518e-03,1.076168e-02,2.883242e-02,4.631437e-02,6.285544e-02,7.813818e-02,9.184202e-02,1.036726e-01,1.134147e-01,1.208720e-01,1.258632e-01,1.283049e-01,1.281630e-01,1.254171e-01,1.201269e-01,1.124047e-01,1.023863e-01,9.028741e-02,7.637370e-02,6.091066e-02,4.420031e-02,2.659271e-02,8.451648e-03,-9.865472e-03,-2.799247e-02,-4.555330e-02,-6.219661e-02,-7.758915e-02,-9.140649e-02,-1.033757e-01,-1.132586e-01,-1.208397e-01,-1.259747e-01,-1.285648e-01,-1.285421e-01,-1.259168e-01,-1.207453e-01,-1.131216e-01,-1.032115e-01,-9.120524e-02,-7.733750e-02,-6.191190e-02,-4.522741e-02,-2.761656e-02,-9.460777e-03,8.899029e-03,2.709772e-02,4.473372e-02,6.147727e-02,7.699034e-02,9.092182e-02,1.030312e-01,1.130884e-01,1.208355e-01,1.261261e-01,1.288760e-01,1.290119e-01,1.265393e-01,1.215058e-01,1.139927e-01,1.041635e-01,9.222634e-02,7.841264e-02,6.299784e-02,4.629512e-02,2.864940e-02,1.041361e-02};
float32_t pOut[512];
float32_t modulo[512/2];
double powerBins[8];

#define MAX_POWER_MAX_SIGNAL 8391402

void startAnalyzer(float32_t * tableStart, uint16_t lenData){

	arm_rfft_fast_init_f32(&S, 512);
	gpioWrite(PORTNUM2PIN(PB, 2), HIGH);
	arm_rfft_fast_f32(&S, tableStart, pOut, 0);
	arm_cmplx_mag_f32(pOut, modulo, 512/2);

	powerBins[0] = modulo[1] + modulo[2] + modulo[3] + modulo[4];
	powerBins[1] = modulo[5] + modulo[6] + modulo[7];
	powerBins[2] = modulo[8] + modulo[9] + modulo[10];
	powerBins[3] = modulo[11] + modulo[12] + modulo[13];
	powerBins[4] = modulo[14] + modulo[15] + modulo[16];
	powerBins[5] = modulo[17] + modulo[18] + modulo[19];
	powerBins[6] = modulo[20] + modulo[21] + modulo[22];
	powerBins[7] = modulo[23] + modulo[24] + modulo[25] + modulo[26] + modulo[27];

	gpioWrite(PORTNUM2PIN(PB, 2), LOW);  // 86Hz/bin
}
void getAnalyzer(uint8_t data [8]){
	for(uint8_t i = 0; i < 8; i++){
		if( powerBins[i] >= MAX_POWER_MAX_SIGNAL * 0.8){
			data[i] = 8;
		}
		else if(powerBins[i] <= MAX_POWER_MAX_SIGNAL * 0.8 && powerBins[i] > MAX_POWER_MAX_SIGNAL * 0.7){
			data[i] = 7;
		}
		else if (powerBins[i] <= MAX_POWER_MAX_SIGNAL * 0.7 && powerBins[i] > MAX_POWER_MAX_SIGNAL * 0.6){
			data[i] = 6;
		}
		else if (powerBins[i] <= MAX_POWER_MAX_SIGNAL * 0.6 && powerBins[i] > MAX_POWER_MAX_SIGNAL * 0.5){
			data[i] = 5;
		}
		else if (powerBins[i] <= MAX_POWER_MAX_SIGNAL * 0.5 && powerBins[i] > MAX_POWER_MAX_SIGNAL * 0.4){
			data[i] = 4;
		}
		else if (powerBins[i] <= MAX_POWER_MAX_SIGNAL * 0.4 && powerBins[i] > MAX_POWER_MAX_SIGNAL * 0.3){
			data[i] = 3;
		}
		else if (powerBins[i] <= MAX_POWER_MAX_SIGNAL * 0.3 && powerBins[i] > MAX_POWER_MAX_SIGNAL * 0.2){
			data[i] = 2;
		}
		else if (powerBins[i] <= MAX_POWER_MAX_SIGNAL * 0.2 && powerBins[i] > MAX_POWER_MAX_SIGNAL * 0.1){
			data[i] = 1;
		}
		else if (powerBins[i] <= MAX_POWER_MAX_SIGNAL * 0.1){
			data[i] = 0;
		}
	}
}

#define NRO_BANDAS 4

static float32_t Bf[4] = {100, 100, 100, 100};// Bandwidth [Hz]
static float32_t GB[4] = {9, 9, 9, 9}; // Bandwidth gain (level at which the bandwidth is measured) [dB]
static float32_t G0[4] = {0, 0, 0, 0}; // Reference gain @ DC [dB]
static float32_t G[4] = {10, 10, 10, 10}; // Boost/cut gain [dB]
static float32_t f0[4] = {200, 500, 1000, 1500}; // Center freqency [Hz]

static float32_t fs = 44100; // Sampling frequency [Hz]

static float32_t pState[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
static float32_t pCoeffs [NRO_BANDAS * 5];
static arm_biquad_casd_df1_inst_f32 Sequ;

void initEqualizer(){
	for(uint16_t i = 0; i < NRO_BANDAS; i++){
		if(G[i] != 0){
			//######## Cuentas ##########

			float32_t beta = tan(Bf[i]/2 * PI / (fs / 2)) * sqrt(abs( pow(pow(10, GB[i]/20), 2) - pow(pow(10, G0[i]/20), 2) )) /
							 sqrt(abs( pow(pow(10, G[i]/20), 2) - pow(pow(10, GB[i]/20), 2) ));

			pCoeffs[i*5] = (pow(10, G0[i]/20) + pow(10, G[i]/20)*beta) / (1+beta); // b0
			pCoeffs[i*5 + 1] = -2*pow(10, G0[i]/20)*cos(f0[i]*PI/(fs/2)) / (1+beta); // b1
			pCoeffs[i*5 + 2] = (pow(10, G0[i]/20) - pow(10, G[i]/20)*beta) / (1+beta); // b2

			pCoeffs[i*5 + 3] = -(-2*cos(f0[i]*PI/(fs/2))/(1+beta)); //a1. Convencion rancia de simbolos
			pCoeffs[i*5 + 4] = -(1-beta)/(1+beta); //a2. Convencion rancia de simbolos
		}
		else{
			pCoeffs[i*5] = 1;
			pCoeffs[i*5 + 1] = 0;
			pCoeffs[i*5 + 2] = 0;

			pCoeffs[i*5 + 3] = 0;
			pCoeffs[i*5 + 4] = 0;
		}
	}
	arm_biquad_cascade_df1_init_f32(&Sequ, 4, pCoeffs, pState);
}

void setUpFilter(float32_t nuevaGananciadB, uint8_t nroBanda){

	G[nroBanda] = nuevaGananciadB;
	GB[nroBanda] = 0.9*nuevaGananciadB;
	if(nuevaGananciadB != 0){
	//######## Cuentas ##########
		float32_t beta = tan(Bf[nroBanda]/2 * PI / (fs / 2)) * sqrt(fabs( pow(pow(10, GB[nroBanda]/20), 2) - pow(pow(10, G0[nroBanda]/20), 2) )) /
						 sqrt(fabs( pow(pow(10, G[nroBanda]/20), 2) - pow(pow(10, GB[nroBanda]/20), 2) ));
		pCoeffs[nroBanda*5] = (pow(10, G0[nroBanda]/20) + pow(10, G[nroBanda]/20)*beta) / (1+beta); // b0
		pCoeffs[nroBanda*5 + 1] = -2*pow(10, G0[nroBanda]/20)*cos(f0[nroBanda]*PI/(fs/2)) / (1+beta); // b1
		pCoeffs[nroBanda*5 + 2] = (pow(10, G0[nroBanda]/20) - pow(10, G[nroBanda]/20)*beta) / (1+beta); // b2

		pCoeffs[nroBanda*5 + 3] = -(-2*cos(f0[nroBanda]*PI/(fs/2))/(1+beta)); //a1. Convencion rancia de simbolos
		pCoeffs[nroBanda*5 + 4] = -(1-beta)/(1+beta); //a2. Convencion rancia de simbolos
	//###########################
	}
	else{
		pCoeffs[nroBanda*5] = 1;
		pCoeffs[nroBanda*5 + 1] = 0;
		pCoeffs[nroBanda*5 + 2] = 0;

		pCoeffs[nroBanda*5 + 3] = 0;
		pCoeffs[nroBanda*5 + 4] = 0;
	}
	arm_biquad_cascade_df1_init_f32(&Sequ, 4, pCoeffs, pState);
}

uint8_t* set_pop(){	
	bands_gain[0]=1;
	bands_gain[1]=2;
	bands_gain[2]=2;
	bands_gain[3]=1;

	setUpFilter(bands_gain[0],0);
	setUpFilter(bands_gain[1],1);
	setUpFilter(bands_gain[2],2);
	setUpFilter(bands_gain[3],3);

	return bands_gain;
}

uint8_t* set_classic(){	
	
	bands_gain[0]=1;
	bands_gain[1]=0;
	bands_gain[2]=1;
	bands_gain[3]=2;

	setUpFilter(bands_gain[0],0);
	setUpFilter(bands_gain[1],1);
	setUpFilter(bands_gain[2],2);
	setUpFilter(bands_gain[3],3);

	return bands_gain;
}

uint8_t* set_rock(){	

	bands_gain[0]=1;
	bands_gain[1]=0;
	bands_gain[2]=0;
	bands_gain[3]=2;

	setUpFilter(bands_gain[0],0);
	setUpFilter(bands_gain[1],1);
	setUpFilter(bands_gain[2],2);
	setUpFilter(bands_gain[3],3);

	return bands_gain;
}

uint8_t* set_techno(){
		
	bands_gain[0]=0;
	bands_gain[1]=0;
	bands_gain[2]=1;
	bands_gain[3]=2;

	setUpFilter(bands_gain[0],0);
	setUpFilter(bands_gain[1],1);
	setUpFilter(bands_gain[2],2);
	setUpFilter(bands_gain[3],3);

	return bands_gain;
}


void blockEqualizer(const float32_t * pSrc, float32_t * pDst, uint32_t 	blockSize){

//########################################
	arm_biquad_cascade_df1_f32(&Sequ, pSrc, pDst, blockSize);
//########################################

}

/**
 * @brief Inicializa un canal FTM en Input Capture
 * @param ftm: módulo FTM
 * @param channel: Canal del modulo FTM
 * @param edge: capture edge
 * @param edgeCb: callback que se llama en cada flanco activo con la cantidad de ticks desde el ultimo.
*/


/*******************************************************************************
 *******************************************************************************
                        LOCAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/






